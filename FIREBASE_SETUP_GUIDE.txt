ðŸ“Š FIREBASE STRUCTURE & SETUP GUIDE

================================================================================
FIRESTORE/REALTIME DATABASE STRUCTURE
================================================================================

PURCHASE NODE STRUCTURE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Realtime Database
â”‚
â””â”€â”€ purchases (NODE UTAMA)
    â”‚
    â””â”€â”€ {userId} (User ID dari Firebase Auth)
        â”‚
        â””â”€â”€ {orderId} (Unik per transaksi, format: ORDER-timestamp)
            â”‚
            â”œâ”€â”€ id: String 
            â”‚   â””â”€ Contoh: "ORDER-1672764900000"
            â”‚
            â”œâ”€â”€ title: String
            â”‚   â””â”€ Contoh: "Wolfish Teeth Yo Yo"
            â”‚
            â”œâ”€â”€ price: Double
            â”‚   â””â”€ Contoh: 264830.3
            â”‚
            â”œâ”€â”€ timestamp: Long
            â”‚   â””â”€ Contoh: 1672764900000
            â”‚   â””â”€ Format: Unix timestamp dalam milliseconds
            â”‚
            â”œâ”€â”€ status: String
            â”‚   â””â”€ Enum: "SUCCESS" | "PENDING" | "FAILED"
            â”‚   â””â”€ Diupdate dari webhook Midtrans
            â”‚
            â”œâ”€â”€ method: String
            â”‚   â””â”€ Contoh: "QRIS"
            â”‚   â””â”€ Bisa: QRIS, Transfer Bank, Kartu Kredit, dll
            â”‚
            â”œâ”€â”€ orderId: String
            â”‚   â””â”€ Contoh: "ORDER-1672764900000"
            â”‚   â””â”€ Same as parent node key
            â”‚
            â”œâ”€â”€ transactionId: String
            â”‚   â””â”€ Contoh: "xxxxxxxxxx-xxxxxxxxxx"
            â”‚   â””â”€ Dari Midtrans (diupdate via webhook)
            â”‚
            â””â”€â”€ bookCover: String
                â””â”€ Contoh: "https://lh3.googleusercontent.com/..."
                â””â”€ URL ke image cover buku

================================================================================
SAMPLE JSON DATA
================================================================================

{
  "purchases": {
    "user_123abc": {
      "ORDER-1672764900000": {
        "id": "ORDER-1672764900000",
        "title": "Wolfish Teeth Yo Yo",
        "price": 264830.3,
        "timestamp": 1672764900000,
        "status": "SUCCESS",
        "method": "QRIS",
        "orderId": "ORDER-1672764900000",
        "transactionId": "xxxxx",
        "bookCover": "https://..."
      },
      "ORDER-1672777200000": {
        "id": "ORDER-1672777200000",
        "title": "Buku Lainnya",
        "price": 89000,
        "timestamp": 1672777200000,
        "status": "PENDING",
        "method": "QRIS",
        "orderId": "ORDER-1672777200000",
        "transactionId": "",
        "bookCover": "https://..."
      }
    }
  }
}

================================================================================
FIREBASE REALTIME DATABASE RULES
================================================================================

RECOMMENDED RULES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  "rules": {
    "purchases": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "status": {
          ".validate": "newData.val() === 'SUCCESS' || newData.val() === 'PENDING' || newData.val() === 'FAILED'"
        }
      }
    },
    "orders": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid"
      }
    }
  }
}

PENJELASAN:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ $uid = user ID dari Firebase Authentication
â€¢ ".read": "$uid === auth.uid" 
  â†’ User hanya bisa baca data mereka sendiri
  
â€¢ ".write": "$uid === auth.uid"
  â†’ User hanya bisa tulis data mereka sendiri

â€¢ Ubah rules di Firebase Console:
  1. Klik Database
  2. Klik Tab "Rules"
  3. Copy-paste rules di atas
  4. Klik "Publish"

================================================================================
SETUP DI FIREBASE CONSOLE
================================================================================

STEP 1: BUAT FIREBASE PROJECT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Buka https://console.firebase.google.com/
2. Klik "Create Project"
3. Nama: "2TAX" (atau nama project Anda)
4. Enable Google Analytics (optional)
5. Create Project

STEP 2: ENABLE REALTIME DATABASE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Di sidebar, klik "Build" â†’ "Realtime Database"
2. Klik "Create Database"
3. Location: Southeast Asia (Singapore) - untuk performa optimal
4. Pilih "Start in test mode" (JANGAN gunakan di production!)
5. Enable

STEP 3: SETUP AUTHENTICATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Di sidebar, klik "Build" â†’ "Authentication"
2. Klik "Get Started"
3. Klik "Email/Password"
4. Enable Email/Password dan Save
5. Optional: Tambah Google Sign-in, etc

STEP 4: UPDATE FIREBASE RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Klik tab "Rules" di Realtime Database
2. Replace dengan rules dari section di atas
3. Klik "Publish"

STEP 5: DOWNLOAD google-services.json
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Di Firebase Console, klik Settings âš™ï¸
2. Klik "Project Settings"
3. Di tab "General", scroll ke bawah
4. Klik "google-services.json" download
5. Copy ke folder: app/google-services.json

STEP 6: SETUP MIDTRANS WEBHOOK (PENTING!)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Buka Midtrans Dashboard
2. Settings â†’ HTTP Notifications
3. Masukkan endpoint: https://your-server.com/webhook
4. Event: Notification URL
5. Webhook akan update status ke Firebase

================================================================================
QUERY DATA DI FIREBASE
================================================================================

KOD KOTLIN UNTUK LOAD DATA:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Load semua purchases user
val uid = FirebaseAuth.getInstance().currentUser?.uid ?: return
val dbRef = FirebaseDatabase.getInstance()
    .getReference("purchases")
    .child(uid)

dbRef.addValueEventListener(object : ValueEventListener {
    override fun onDataChange(snapshot: DataSnapshot) {
        for (data in snapshot.children) {
            val purchase = data.getValue(Purchase::class.java)
            if (purchase != null) {
                // Process purchase
            }
        }
    }
    
    override fun onCancelled(error: DatabaseError) {
        // Handle error
    }
})

// Load purchase dengan status SUCCESS only
dbRef.orderByChild("status")
    .equalTo("SUCCESS")
    .addValueEventListener(...)

================================================================================
STRUKTUR ORDERS NODE (INTERNAL)
================================================================================

Untuk tracking internal:

orders/
  {userId}/
    ORDER-timestamp/
      â”œâ”€â”€ order_id: String
      â”œâ”€â”€ title: String
      â”œâ”€â”€ price: Double
      â”œâ”€â”€ timestamp: Long
      â”œâ”€â”€ status_pembayaran: "pending" | "success" | "failed"
      â”œâ”€â”€ method: "Midtrans"
      â”œâ”€â”€ snap_token: String (dari Midtrans)
      â””â”€â”€ redirect_url: String (Payment gateway URL)

Note: Node ini biasanya tidak ditampilkan ke user, hanya untuk tracking

================================================================================
DATA VALIDATION
================================================================================

VALIDASI YANG DILAKUKAN:

1. PRICE:
   â€¢ Must be > 0
   â€¢ Type: Double

2. TIMESTAMP:
   â€¢ Must be > 0
   â€¢ Type: Long (milliseconds)

3. STATUS:
   â€¢ Only: "SUCCESS", "PENDING", "FAILED"
   â€¢ Type: String

4. METHOD:
   â€¢ Examples: "QRIS", "Transfer", "Kartu Kredit"
   â€¢ Type: String

5. TITLE:
   â€¢ Must not be empty
   â€¢ Type: String

================================================================================
PAGINATION (OPTIONAL FUTURE)
================================================================================

Jika ada banyak data, bisa implement pagination:

// Load 10 data terbaru
dbRef.orderByChild("timestamp")
    .limitToLast(10)
    .addValueEventListener(...)

// Dengan offset (page 2)
dbRef.orderByChild("timestamp")
    .limitToLast(20)  // 10 data + 10 offset
    .addValueEventListener(...)

================================================================================
MONITORING & DEBUGGING
================================================================================

DI FIREBASE CONSOLE:

1. Buka Database
2. Lihat struktur data real-time
3. Klik pada node untuk lihat value
4. Lihat "Rules Simulator" untuk test permissions
5. Lihat "Storage" untuk tracking usage

DI ANDROID STUDIO (Logcat):

Log.d("PaymentActivity", "Purchase history saved")
Log.e("HistoryFragment", "Error loading: ${error.message}")

================================================================================
BACKUP & EXPORT
================================================================================

BACKUP DATA (Optional):

1. Realtime Database â†’ Settings
2. Backups
3. Klik "Create Backup"
4. Data akan di-backup ke Cloud Storage

EXPORT DATA:

1. Firebase Console â†’ Realtime Database
2. Kebab menu (â‹®) â†’ Export JSON
3. Download data sebagai JSON file

================================================================================
PRICING
================================================================================

Firebase Realtime Database:
â€¢ Free tier: 100 concurrent connections, 1GB storage
â€¢ Pay-as-you-go: $1 per GB downloaded, $5 per GB stored

Untuk app kecil, free tier biasanya cukup!

================================================================================
TROUBLESHOOTING
================================================================================

ERROR: "Permission denied"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Solusi:
1. Check Firebase Rules (update dengan rules di atas)
2. Pastikan user sudah login
3. Check UID di rules = auth.uid

ERROR: "Network error"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Solusi:
1. Check internet connection
2. Check Firebase Console status
3. Pastikan google-services.json correct

ERROR: Data tidak muncul
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Solusi:
1. Verifikasi data ada di Firebase Console
2. Check uid = auth.uid yang sekarang login
3. Check apakah data sudah saved (check PaymentActivity logs)
4. Refresh app (pull-to-refresh atau restart)

ERROR: Crash saat load data
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Solusi:
1. Check LogCat untuk error message
2. Pastikan Purchase.kt compatible dengan data
3. Check database listener di-detach (di onDestroy)

================================================================================
